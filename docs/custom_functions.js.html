<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: custom_functions.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: custom_functions.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @typedef {object} IndicesRef
 * @property {object} ColumnIndices
 * @property {ojbect} RowIndices
 */

/** 
 * 0-based column indices
 */
const SheetIndices = {
    StateStats: {
        ColumnIndices: {
            StatDate: 0,
            StateCode: 1,
            Positive: 2,
            Negative: 3,
            Pending: 4,
            HospitalizedCurrent: 5,
            HospitalizedTotal: 6,
            OnVentilatorCurrent: 9,
            OnVentilatorTotal: 10,
            Recovered: 11,
            Hash: 12,
            Deaths: 14,
            Hospitalized: 15,
            Total: 16,
            TotalTestResults: 17,
            PositiveToNegative: 18,
            Fips: 19,
            DeathsIncrease: 20,
            HospitalizedIncrease: 21,
            NegativeIncrease: 22,
            PositiveIncrease: 23,
            TotalTestsIncrease: 24
        }
    },
    Covid19: {
        ColumnIndices: {
            StateCode: 1,
            StateName: 2,
            Infections: 3,
            Infection1DayChange: 4,
            InfectionYesterday: 5,
            Infection7DayChange: 6,
            InfectionsTotalTo7DayAvg: 7,
            Hospital1DayChange: 9,
            HospitalYesterday: 10,
            HospitalsTotalTo7DayAvg: 11,
            Deaths: 12,
            Death1DayChange : 13,
            DeathYesterday: 14,
            Death7DayChange: 15,
            Population: 42,
            Hospitalized: {
                Increase: 21
            }
        }
    }
};

/**
 * @summary gets either new or cached column indices
 * @returns {SheetIndices}
 */
function getIndices() {
    const { indices } = this;
    
    if(!indices) {
        this.indices = SheetIndices;
        return SheetIndices;
    }

    return SheetIndices;
}

/**
 * Counts metric by N millions of people
 * @param {boolean} isTotalByCountry set to true when used as US total
 * @param {Date} date reference to current date cell
 * @param {(number|string)[][]} stateData reference to COVID19 sheet data
 * @param {number[][]} statValues reference to column with per state statistics
 * @param {string} statColumn column with metric data A1 reference
 * @param {number} periodStartOffset period offset, in days
 * @param {number} numMillions number of millions to count against
 * @return {number[][]}
 * @customfunction
 */
function metricPerMillions(
    isTotalByCountry,
    date,
    stateData,
    statValues,
    statColumn,
    numMillions = 1,
    periodEndOffset = 0,
    periodStartOffset = 6
) {
    const currDateMs = date.valueOf();

    const currDateValue = (currDateMs - 864e5 * periodEndOffset);
    const nDaysAgoValue = (currDateMs - 864e5 * periodStartOffset);

    const { Covid19, StateStats } = SheetIndices;

    const metricsColIdx = getIndexFromA1(statColumn);

    const result = stateData
        .map((columnValues) => {
            const population = columnValues[Covid19.ColumnIndices.Population];
            const stateCode = columnValues[Covid19.ColumnIndices.StateCode];

            const relativePopulation = population / (1e6 * numMillions);

            const stateStatsForNdays = statValues
                .slice(1)
                .reduce((acc, cur) => {
                    const statStateCode = cur[StateStats.ColumnIndices.StateCode];
                    const statDate = cur[StateStats.ColumnIndices.StatDate];

                    const sameState = isTotalByCountry || statStateCode === stateCode;

                    const dateMs = datenumToValue(statDate);

                    const inOffset = dateMs >= nDaysAgoValue &amp;&amp; dateMs &lt;= currDateValue;

                    return sameState &amp;&amp; inOffset ? acc + cur[metricsColIdx] : acc;
                }, 0);

            return [stateStatsForNdays / relativePopulation];
        });

    return result;
}

/**
 * Returns percent of change over last week
 * @param {number[][]} dividends 
 * @param {number[][]} divisors 
 * @return {string}
 * @customfunction
 */
const percentToPreviousWeek = (dividends, divisors) => {
    return dividends.map(([dividend], rowIdx) => {
        const [divisor] = divisors[rowIdx];
        
        if(!divisor) {
            return "+N/A%";
        }

        return topercent((dividend - divisor) / (divisor || 1));
    });
};</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#addCommas">addCommas</a></li><li><a href="global.html#addSign">addSign</a></li><li><a href="global.html#buildRatioStatement">buildRatioStatement</a></li><li><a href="global.html#buildStatement">buildStatement</a></li><li><a href="global.html#colorLink">colorLink</a></li><li><a href="global.html#Covid19Refresh">Covid19Refresh</a></li><li><a href="global.html#Covid19Refresh_BACKUP">Covid19Refresh_BACKUP</a></li><li><a href="global.html#datenumToValue">datenumToValue</a></li><li><a href="global.html#deep">deep</a></li><li><a href="global.html#doApprove">doApprove</a></li><li><a href="global.html#fetchAndParseContent">fetchAndParseContent</a></li><li><a href="global.html#getcelldate">getcelldate</a></li><li><a href="global.html#getCurrentlySelectedCandidate">getCurrentlySelectedCandidate</a></li><li><a href="global.html#getDayOfWeek">getDayOfWeek</a></li><li><a href="global.html#getIndexFromA1">getIndexFromA1</a></li><li><a href="global.html#getIndices">getIndices</a></li><li><a href="global.html#getOrInitProp">getOrInitProp</a></li><li><a href="global.html#getOrInstallInfectionsByTests">getOrInstallInfectionsByTests</a></li><li><a href="global.html#getOrIntallTrigger">getOrIntallTrigger</a></li><li><a href="global.html#getResetDateValue">getResetDateValue</a></li><li><a href="global.html#getSavedState">getSavedState</a></li><li><a href="global.html#getTotalByUS">getTotalByUS</a></li><li><a href="global.html#getUserEmail">getUserEmail</a></li><li><a href="global.html#GreenRed2">GreenRed2</a></li><li><a href="global.html#handleError">handleError</a></li><li><a href="global.html#include">include</a></li><li><a href="global.html#infectionsByTestsByCountry">infectionsByTestsByCountry</a></li><li><a href="global.html#insallTrigger">insallTrigger</a></li><li><a href="global.html#installInfectionsByTests">installInfectionsByTests</a></li><li><a href="global.html#isZero">isZero</a></li><li><a href="global.html#JSONtoQuery">JSONtoQuery</a></li><li><a href="global.html#LoadTwitter">LoadTwitter</a></li><li><a href="global.html#makeAnalyticsQuery">makeAnalyticsQuery</a></li><li><a href="global.html#metricPerMillions">metricPerMillions</a></li><li><a href="global.html#onOpen">onOpen</a></li><li><a href="global.html#ordinal_suffix_of">ordinal_suffix_of</a></li><li><a href="global.html#percentToPreviousWeek">percentToPreviousWeek</a></li><li><a href="global.html#pluralizeCountable">pluralizeCountable</a></li><li><a href="global.html#promptSendoutStats">promptSendoutStats</a></li><li><a href="global.html#RedGreen2">RedGreen2</a></li><li><a href="global.html#resetPersistedState">resetPersistedState</a></li><li><a href="global.html#safeApprove">safeApprove</a></li><li><a href="global.html#sandboxApprove">sandboxApprove</a></li><li><a href="global.html#sendout">sendout</a></li><li><a href="global.html#sentenceCase">sentenceCase</a></li><li><a href="global.html#setDecimalPlaces">setDecimalPlaces</a></li><li><a href="global.html#SheetIndices">SheetIndices</a></li><li><a href="global.html#splitIntoConseq">splitIntoConseq</a></li><li><a href="global.html#topercent">topercent</a></li><li><a href="global.html#trackEmailOpen">trackEmailOpen</a></li><li><a href="global.html#trackLinkClick">trackLinkClick</a></li><li><a href="global.html#updateInfectsionsByTests">updateInfectsionsByTests</a></li><li><a href="global.html#validForSending">validForSending</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.4</a> on Sun Jun 21 2020 07:57:02 GMT+0300 (Moscow Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
