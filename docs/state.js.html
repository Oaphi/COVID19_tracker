<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: state.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: state.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>//no support for class props in GAS yet;
const StateStatics = {
    defStart: 2,
    defThreshold: 5,

    /** @type {State} */
    initializedState: null
};

var State = class {

    /**
     * @typedef {({
     *  callback : function (State, number) : any,
     *  start : (number | undefined),
     *  storeName : (string | undefined),
     *  threshold : (number | undefined)
     * })} stateConfig
     * 
     * @param {stateConfig} arg0
     */
    constructor({
        callback = (state) => state,
        start = StateStatics.defStart,
        storeName = "continuator",
        threshold = StateStatics.defThreshold
    } = {}) {

        this.callback = callback;

        this.processed = 0;

        this.previousFailures = 0;
        this.previousSuccesses = 0;
        this.succeeded = 0;
        this.failed = 0;

        this.start = +start;

        this.threshold = +threshold * 6e4;

        this.timezone = Session.getScriptTimeZone();

        this.storeName = storeName;

        this.startedAt = Date.now();
        this.lastTimeFailed = 0;
        this.lastTimeSucceeded = 0;
    }

    /**
     * @summary gets or initializes state
     * @param {stateConfig} [initConfig] 
     * @returns {State}
     */
    static getState(initConfig) {

        const { initializedState } = StateStatics;

        if (!initializedState) {
            StateStatics.initializedState = new State(initConfig).load();
        }

        return StateStatics.initializedState;
    }

    /**
     * @summary signals all done and resets everything
     * @returns {State}
     */
    allDone() {

        const store = PropertiesService.getScriptProperties();

        store.deleteProperty(this.storeName);

        this.reset();

        console.log("All done, saving state");

        return this.saveSuccess();
    }

    /**
     * @summary checks if can continue working
     * @returns {boolean}
     */
    canContinue() {

        const {
            threshold,
            startedAt = Date.now()
        } = this;

        const current = Date.now();

        return current &lt; (startedAt + threshold);
    }

    /**
     * @summary launches the execution if under threshold
     * 
     * @description
     * When called, checks if can continue
     *      if not
     *          persists failure info and exits
     *      else
     *          runs callback
     *          increments start on success
     * 
     * @returns {State}
     */
    continue() {

        if (!this.canContinue()) {

            console.log("Over the threshold, aborting");

            return this.saveFailure();
        }

        const { start, callback } = this;

        callback(this, start);

        return this;
    }

    countFailed() {
        this.failed += 1;
        return this;
    }

    countSucceeded() {
        this.succeeded += 1;
        return this;
    }

    /**
     * @summary increments processed items counter
     * @param {number} [step]
     * @returns {State}
     */
    countProcessed(step = 1) {
        this.processed += step;
        return this;
    }

    /**
     * @summary increments starting position only if never failed
     * @param {number} [step]
     * @returns {State}
     */
    incrementStartIfNoFailures(step = 1) {
        this.failed || (this.start += step);
        return this.countProcessed();
    }

    /**
     * @summary persists failure info
     * @returns {State}
     */
    saveFailure() {
        this.lastTimeSucceeded = 0;
        this.lastTimeFailed = Date.now();
        console.log(`Saving failure at ${this.lastTimeFailed}`);
        return this.save();
    }

    /**
     * @summary persists success info
     * @returns {State}
     */
    saveSuccess() {
        this.lastTimeFailed = 0;
        this.lastTimeSucceeded = Date.now();
        console.log(`Saving success at ${this.lastTimeSucceeded}`);
        return this.save();
    }

    /**
     * @summary loads the persisted state
     * @returns {State}
     */
    load() {
        const store = PropertiesService.getScriptProperties();

        const { storeName } = this;

        const saved = store.getProperty(storeName) || "{}";

        const parsed = JSON.parse(saved);

        for (const key in parsed) {
            const value = parsed[key];

            //skip persisted start if user decided to start later
            if(key === "start" &amp;&amp; value &lt; this[key] ) {
                continue;
            }

            this[key] = parsed[key];
        }

        console.log(`Loading state: ${JSON.stringify(this)}`);

        return this;
    }

    /**
     * @summary resets state configuration to defaults
     * @returns {State}
     */
    reset() {

        delete this.startedAt;

        this.processed = 0;

        this.initialStart = StateStatics.defStart;
        this.start = StateStatics.defStart;

        this.threshold = StateStatics.defThreshold * 6e4;

        console.log(`Resetting state: ${JSON.stringify(this)}`);

        return this;
    }

    /**
     * @summary resets all state data (including persisted)
     * @returns {State}
     */
    fullReset() {

        console.log(`Performing full state reset`);

        this.reset();

        this.lastTimeFailed = 0;
        this.lastTimeSucceeded = 0;

        return this.save();
    }

    /**
     * @summary persists state config
     * @returns {State}
     */
    save() {
        const store = PropertiesService.getScriptProperties();

        const {
            failed,
            succeeded,
            storeName,
            start,
            lastTimeFailed,
            lastTimeSucceeded,
            threshold,
            timezone
        } = this;

        const toSave = {
            previousFailures: failed,
            previousSuccesses: succeeded,
            lastTimeFailed,
            lastTimeSucceeded,
            start,
            threshold,
            timezone
        };

        const prepared = JSON.stringify(toSave);

        console.log(`Saving current state: ${prepared}`);

        store.setProperty(storeName, prepared);

        return this;
    }

    /**
     * @summary sets threshold that stops execution
     * @param {number} minutes 
     * @returns {State}
     */
    setThreshold(minutes = 5) {
        this.threshold = minutes * 6e4;
        return this;
    }

};

/**
 * @summary handles state reset
 * @returns {void}
 */
const resetPersistedState = () => {
    const state = new State();
    state.fullReset();
};</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#addCommas">addCommas</a></li><li><a href="global.html#addSign">addSign</a></li><li><a href="global.html#buildStatement">buildStatement</a></li><li><a href="global.html#colorLink">colorLink</a></li><li><a href="global.html#Covid19Refresh">Covid19Refresh</a></li><li><a href="global.html#Covid19Refresh_BACKUP">Covid19Refresh_BACKUP</a></li><li><a href="global.html#deep">deep</a></li><li><a href="global.html#doApprove">doApprove</a></li><li><a href="global.html#fetchAndParseContent">fetchAndParseContent</a></li><li><a href="global.html#getcelldate">getcelldate</a></li><li><a href="global.html#getCurrentlySelectedCandidate">getCurrentlySelectedCandidate</a></li><li><a href="global.html#getDayOfWeek">getDayOfWeek</a></li><li><a href="global.html#getOrInitProp">getOrInitProp</a></li><li><a href="global.html#getOrInstallInfectionsByTests">getOrInstallInfectionsByTests</a></li><li><a href="global.html#getOrIntallTrigger">getOrIntallTrigger</a></li><li><a href="global.html#getSavedState">getSavedState</a></li><li><a href="global.html#getTotalByUS">getTotalByUS</a></li><li><a href="global.html#GreenRed2">GreenRed2</a></li><li><a href="global.html#handleError">handleError</a></li><li><a href="global.html#include">include</a></li><li><a href="global.html#insallTrigger">insallTrigger</a></li><li><a href="global.html#installInfectionsByTests">installInfectionsByTests</a></li><li><a href="global.html#isZero">isZero</a></li><li><a href="global.html#JSONtoQuery">JSONtoQuery</a></li><li><a href="global.html#LoadTwitter">LoadTwitter</a></li><li><a href="global.html#makeAnalyticsQuery">makeAnalyticsQuery</a></li><li><a href="global.html#onOpen">onOpen</a></li><li><a href="global.html#ordinal_suffix_of">ordinal_suffix_of</a></li><li><a href="global.html#pluralizeCountable">pluralizeCountable</a></li><li><a href="global.html#RedGreen2">RedGreen2</a></li><li><a href="global.html#resetPersistedState">resetPersistedState</a></li><li><a href="global.html#sandboxApprove">sandboxApprove</a></li><li><a href="global.html#sendout">sendout</a></li><li><a href="global.html#setDecimalPlaces">setDecimalPlaces</a></li><li><a href="global.html#splitIntoConseq">splitIntoConseq</a></li><li><a href="global.html#topercent">topercent</a></li><li><a href="global.html#trackEmailOpen">trackEmailOpen</a></li><li><a href="global.html#trackLinkClick">trackLinkClick</a></li><li><a href="global.html#updateInfectsionsByTests">updateInfectsionsByTests</a></li><li><a href="global.html#validForSending">validForSending</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.4</a> on Mon Jun 01 2020 16:42:24 GMT+0300 (Moscow Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
