<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: triggers.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: triggers.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @summary generates main menu of the script
 * @param {GoogleAppsScript.Events.SheetsOnOpen} e event object
 * @returns {void}
 */
function onOpen() {

    getOrInstallInfectionsByTests();

    const ui = SpreadsheetApp.getUi();

    ui.createMenu('Covid19_Send_Email')
        .addItem('Approve', 'doApprove')
        .addSeparator()
        .addItem("Sandbox", "sandboxApprove")
        .addItem("Reset", "resetPersistedState")
        .addToUi();

    ui.createMenu('Refresh_Data')
        .addItem('Refresh', 'Covid19Refresh')
        .addToUi();
}


/**
 * @summary gets or installs a trigger
 * @param {string} callbackName
 * @param {GoogleAppsScript.Script.EventType} type
 * @param {function} installer
 */
const getOrIntallTrigger = (callbackName, type, installer) =>

    /**
     * @returns {?GoogleAppsScript.Script.Trigger}
     */
    () => {

        console.log(`Checking for triggered ${callbackName} function`);

        const ss = SpreadsheetApp.getActiveSpreadsheet();

        const triggers = ScriptApp.getUserTriggers(ss);

        const found = triggers
            .filter(trigger => trigger.getEventType() === type &amp;&amp; trigger.getHandlerFunction() === callbackName);

        const [trigger] = found;

        !trigger &amp;&amp; installer();

        return trigger;
    };

/**
 * @summary installs a trigger
 * @param {string} callbackName 
 * @param {GoogleAppsScript.Script.EventType} type
 */
const insallTrigger = (callbackName, type) =>

    () => {

        console.log(`Installing triggered ${callbackName} function`);

        const ss = SpreadsheetApp.getActiveSpreadsheet();

        const builder = ScriptApp.newTrigger(callbackName);

        const spreadBuilder = builder.forSpreadsheet(ss);

        /** @type {Map.&lt;string, function(GoogleAppsScript.Script.SpreadsheetTriggerBuilder) } */
        const typeMap = new Map();

        const { EventType } = ScriptApp;

        typeMap
            .set(EventType.ON_CHANGE, (builder) => builder.onChange())
            .set(EventType.ON_EDIT, (builder) => builder.onEdit())
            .set(EventType.ON_OPEN, (builder) => builder.onOpen());

        const typed = typeMap.get(type)(spreadBuilder);

        typed.create();
    };

/**
 * @summary partiallly applied installer for infections by tests ratio
 */
const installInfectionsByTests = insallTrigger(
    "updateInfectsionsByTests",
    ScriptApp.EventType.ON_CHANGE
);

/**
 * @summary partiallly applied getter-installer for infections by tests ratio
 */
const getOrInstallInfectionsByTests = getOrIntallTrigger(
    "updateInfectsionsByTests",
    ScriptApp.EventType.ON_CHANGE,
    installInfectionsByTests
);</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#addCommas">addCommas</a></li><li><a href="global.html#addSign">addSign</a></li><li><a href="global.html#buildRatioStatement">buildRatioStatement</a></li><li><a href="global.html#buildStatement">buildStatement</a></li><li><a href="global.html#colorLink">colorLink</a></li><li><a href="global.html#Covid19Refresh">Covid19Refresh</a></li><li><a href="global.html#Covid19Refresh_BACKUP">Covid19Refresh_BACKUP</a></li><li><a href="global.html#datenumToValue">datenumToValue</a></li><li><a href="global.html#deep">deep</a></li><li><a href="global.html#doApprove">doApprove</a></li><li><a href="global.html#fetchAndParseContent">fetchAndParseContent</a></li><li><a href="global.html#getcelldate">getcelldate</a></li><li><a href="global.html#getCurrentlySelectedCandidate">getCurrentlySelectedCandidate</a></li><li><a href="global.html#getDayOfWeek">getDayOfWeek</a></li><li><a href="global.html#getIndexFromA1">getIndexFromA1</a></li><li><a href="global.html#getIndices">getIndices</a></li><li><a href="global.html#getOrInitProp">getOrInitProp</a></li><li><a href="global.html#getOrInstallInfectionsByTests">getOrInstallInfectionsByTests</a></li><li><a href="global.html#getOrIntallTrigger">getOrIntallTrigger</a></li><li><a href="global.html#getResetDateValue">getResetDateValue</a></li><li><a href="global.html#getSavedState">getSavedState</a></li><li><a href="global.html#getTotalByUS">getTotalByUS</a></li><li><a href="global.html#getUserEmail">getUserEmail</a></li><li><a href="global.html#GreenRed2">GreenRed2</a></li><li><a href="global.html#handleError">handleError</a></li><li><a href="global.html#include">include</a></li><li><a href="global.html#infectionsByTestsByCountry">infectionsByTestsByCountry</a></li><li><a href="global.html#insallTrigger">insallTrigger</a></li><li><a href="global.html#installInfectionsByTests">installInfectionsByTests</a></li><li><a href="global.html#isZero">isZero</a></li><li><a href="global.html#JSONtoQuery">JSONtoQuery</a></li><li><a href="global.html#LoadTwitter">LoadTwitter</a></li><li><a href="global.html#makeAnalyticsQuery">makeAnalyticsQuery</a></li><li><a href="global.html#metricPerMillions">metricPerMillions</a></li><li><a href="global.html#onOpen">onOpen</a></li><li><a href="global.html#ordinal_suffix_of">ordinal_suffix_of</a></li><li><a href="global.html#percentToPreviousWeek">percentToPreviousWeek</a></li><li><a href="global.html#pluralizeCountable">pluralizeCountable</a></li><li><a href="global.html#promptSendoutStats">promptSendoutStats</a></li><li><a href="global.html#RedGreen2">RedGreen2</a></li><li><a href="global.html#resetPersistedState">resetPersistedState</a></li><li><a href="global.html#sandboxApprove">sandboxApprove</a></li><li><a href="global.html#sendout">sendout</a></li><li><a href="global.html#sentenceCase">sentenceCase</a></li><li><a href="global.html#setDecimalPlaces">setDecimalPlaces</a></li><li><a href="global.html#SheetIndices">SheetIndices</a></li><li><a href="global.html#splitIntoConseq">splitIntoConseq</a></li><li><a href="global.html#topercent">topercent</a></li><li><a href="global.html#trackEmailOpen">trackEmailOpen</a></li><li><a href="global.html#trackLinkClick">trackLinkClick</a></li><li><a href="global.html#updateInfectsionsByTests">updateInfectsionsByTests</a></li><li><a href="global.html#validForSending">validForSending</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.4</a> on Wed Jun 17 2020 16:04:41 GMT+0300 (Moscow Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
