<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: approval.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: approval.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @summary builds confirmation popup
 * 
 * @param {{
 *  safe : (boolean|undefined),
 *  sandboxed : (boolean|undefined),
 *  max : number
 * }} config
 * 
 * @returns {boolean}
 */
function doApprove({
    sandboxed = false,
    safe = false
} = {}) {
    const quotaInfo = checkRemainingQuota();

    const config = { sandboxed, safe };
    safe &amp;&amp; (config.max = quotaInfo.remaining);

    const userEmail = getUserEmail();

    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();

    const { statsShName, userShName } = CONFIG;
    const covidStatsSheet = spreadsheet.getSheetByName(statsShName);
    const usersSheet = spreadsheet.getSheetByName(userShName);

    const ui = SpreadsheetApp.getUi();

    const selectedUserRow = getCurrentlySelectedCandidate(usersSheet);

    const state = State
        .getState({
            start: selectedUserRow,
            callback: sendout(usersSheet, covidStatsSheet, config),
            type: sandboxed ? "sandbox" : "production"
        });

    selectedUserRow &amp;&amp; state.overrideStart(selectedUserRow);

    const candidate = getCandidateFromRow(usersSheet, selectedUserRow || state.start);
    
    const safePrompt = safe ? "in safe mode" : "";

    const response = ui.alert(
        `Starting ${safePrompt} from user ${candidate.name}, state ${candidate.state}, confirm?`,
        ui.ButtonSet.YES_NO
    );

    if (response === ui.Button.YES) {

        const {
            availablePercent,
            remaining,
            status
        } = quotaInfo;

        if (status) {

            const pluralEmail = pluralizeCountable(remaining, "email");

            const numSendable = `\n\nYou will be able to send ${pluralEmail}`;

            const {
                previousFailures,
                previousSuccesses,
                lastTimeFailed,
                lastTimeSucceeded
            } = state;

            const pluralFailure = pluralizeCountable(previousFailures, "problem");
            const pluralSuccess = pluralizeCountable(previousSuccesses, "email");

            const lastError = lastTimeFailed ? `\nLast problem: ${new Date(lastTimeFailed).toLocaleString()} (${pluralFailure} found)` : "";

            const lastSuccess = lastTimeSucceeded ? `\nLast success: ${new Date(lastTimeSucceeded).toLocaleString()} (${pluralSuccess} sent)` : "";

            const lastRan = lastError || lastSuccess ? `\n${lastError}${lastSuccess}\n` : "\n";

            const shouldContinue = ui.alert(
                `Your Daily Quota`,
                `Daily quota remaining: ${availablePercent}%.${numSendable}${lastRan}\nContinue?`,
                ui.ButtonSet.YES_NO
            );

            if (shouldContinue === ui.Button.NO || shouldContinue === ui.Button.CLOSE) {
                console.log("Sendout cancelled");
                return false;
            }

            state.continue();

            console.log('Mail sent successfully');

            return true;
        }

        ui.alert(`You reached the quota limit for the account:\n\n${userEmail}`);
        console.log("Mailing quota overflow");
        return false;
    }

    console.log('Sendout unconfirmed');
    return false;
}

/**
 * @summary gets row index if selected an email to start from
 * @param {GoogleAppsScript.Spreadsheet.Sheet} sheet 
 * @returns {(number | undefined)}
 */
const getCurrentlySelectedCandidate = (sheet) => {

    const activeCell = sheet.getActiveCell();

    const emailListColumn = 3;

    if (activeCell.getColumn() === emailListColumn) {
        return activeCell.getRow();
    }
};

/**
 * @typedef {({
 *  availablePercent : number,
 *  status : boolean,
 *  remaining : number
 * })} quotaResult
 * 
 * @summary checks remaining quota
 * @returns {quotaResult}
 */
const checkRemainingQuota = () => {

    const quota = MailApp.getRemainingDailyQuota();

    const maxUniqueEmails = 1500;

    return ({
        remaining: quota,
        status: quota > 0,
        get availablePercent() {
            return Math.round((this.remaining / maxUniqueEmails) * 100);
        }
    });
};

/**
 * @summary launches the workflow, but does not send out the emails
 */
const sandboxApprove = () => {

    const config = {
        sandboxed: true
    };

    return doApprove(config);
};

const safeSandboxApprove = () => {
    return doApprove({
        safe: true,
        sandboxed: true
    });
};

/**
 * @summary launches the workflow, but stops as soon as quota is reached
 */
const safeApprove = () => {

    const config = {
        safe: true
    };

    return doApprove(config);
};</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#addCommas">addCommas</a></li><li><a href="global.html#addSign">addSign</a></li><li><a href="global.html#buildRatioStatement">buildRatioStatement</a></li><li><a href="global.html#buildStatement">buildStatement</a></li><li><a href="global.html#colorLink">colorLink</a></li><li><a href="global.html#Covid19Refresh">Covid19Refresh</a></li><li><a href="global.html#Covid19Refresh_BACKUP">Covid19Refresh_BACKUP</a></li><li><a href="global.html#datenumToValue">datenumToValue</a></li><li><a href="global.html#deep">deep</a></li><li><a href="global.html#doApprove">doApprove</a></li><li><a href="global.html#fetchAndParseContent">fetchAndParseContent</a></li><li><a href="global.html#getcelldate">getcelldate</a></li><li><a href="global.html#getCurrentlySelectedCandidate">getCurrentlySelectedCandidate</a></li><li><a href="global.html#getDayOfWeek">getDayOfWeek</a></li><li><a href="global.html#getIndexFromA1">getIndexFromA1</a></li><li><a href="global.html#getIndices">getIndices</a></li><li><a href="global.html#getOrInitProp">getOrInitProp</a></li><li><a href="global.html#getOrInstallInfectionsByTests">getOrInstallInfectionsByTests</a></li><li><a href="global.html#getOrIntallTrigger">getOrIntallTrigger</a></li><li><a href="global.html#getResetDateValue">getResetDateValue</a></li><li><a href="global.html#getSavedState">getSavedState</a></li><li><a href="global.html#getTotalByUS">getTotalByUS</a></li><li><a href="global.html#getUserEmail">getUserEmail</a></li><li><a href="global.html#GreenRed2">GreenRed2</a></li><li><a href="global.html#handleError">handleError</a></li><li><a href="global.html#include">include</a></li><li><a href="global.html#infectionsByTestsByCountry">infectionsByTestsByCountry</a></li><li><a href="global.html#insallTrigger">insallTrigger</a></li><li><a href="global.html#installInfectionsByTests">installInfectionsByTests</a></li><li><a href="global.html#isZero">isZero</a></li><li><a href="global.html#JSONtoQuery">JSONtoQuery</a></li><li><a href="global.html#LoadTwitter">LoadTwitter</a></li><li><a href="global.html#makeAnalyticsQuery">makeAnalyticsQuery</a></li><li><a href="global.html#metricPerMillions">metricPerMillions</a></li><li><a href="global.html#onOpen">onOpen</a></li><li><a href="global.html#ordinal_suffix_of">ordinal_suffix_of</a></li><li><a href="global.html#percentToPreviousWeek">percentToPreviousWeek</a></li><li><a href="global.html#pluralizeCountable">pluralizeCountable</a></li><li><a href="global.html#promptSendoutStats">promptSendoutStats</a></li><li><a href="global.html#RedGreen2">RedGreen2</a></li><li><a href="global.html#resetPersistedState">resetPersistedState</a></li><li><a href="global.html#safeApprove">safeApprove</a></li><li><a href="global.html#sandboxApprove">sandboxApprove</a></li><li><a href="global.html#sendout">sendout</a></li><li><a href="global.html#sentenceCase">sentenceCase</a></li><li><a href="global.html#setDecimalPlaces">setDecimalPlaces</a></li><li><a href="global.html#SheetIndices">SheetIndices</a></li><li><a href="global.html#splitIntoConseq">splitIntoConseq</a></li><li><a href="global.html#topercent">topercent</a></li><li><a href="global.html#trackEmailOpen">trackEmailOpen</a></li><li><a href="global.html#trackLinkClick">trackLinkClick</a></li><li><a href="global.html#updateInfectsionsByTests">updateInfectsionsByTests</a></li><li><a href="global.html#validForSending">validForSending</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.4</a> on Sun Jun 21 2020 07:57:02 GMT+0300 (Moscow Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
